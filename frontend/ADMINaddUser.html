<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Metrobank Training Bootcamp - Add User</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="basedashboard.css" />
    <link rel="stylesheet" href="newUploadStyles.css" />

    <!-- Icons & Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="logo.png" alt="logo" />
            <h2>Admin</h2>
        </div>
        <ul class="sidebar-links">
            <h4><span>Main Menu</span><div class="menu-separator"></div></h4>
            <li><a href="ADMINdashboard.html"><span class="material-symbols-outlined">dashboard</span>Dashboard</a></li>

            <h4><span>User Management</span><div class="menu-separator"></div></h4>
            <li><a href="ADMINaddUser.html"><span class="material-symbols-outlined">person_add</span>Add User</a></li>
            <li><a href="ADMINarchive.html"><span class="material-symbols-outlined">archive</span>Archive</a></li>

            <h4><span>System</span><div class="menu-separator"></div></h4>
            <li><a href="ADMINsettings.html"><span class="material-symbols-outlined">settings</span>Settings</a></li>
            <li><a href="mainlayout.html"><span class="material-symbols-outlined">logout</span>Logout</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <div class="main">
        <section class="adduser-form-section">
            <div class="panel-header-row">
                <button type="button" class="btn-box back-icon-btn" onclick="window.history.back()">
                    <i class="material-icons">arrow_back</i>
                </button>
                <h2 class="form-title">Add New User</h2>
            </div>
            <form id="addUserForm" class="adduser-form" autocomplete="off" enctype="multipart/form-data">

                <label for="userName">Full Name</label> <!-- NAME -->
                <input type="text" id="userName" placeholder="Enter full name" required />

                <div class="meta-row">
                    <div class="form-group">
                        <label for="userType">User Type</label> <!-- USER TYPE -->
                        <select id="userType" required>
                            <option value="" disabled selected>Select user type</option>
                            <option value="SME">SME</option>
                            <option value="Admin">Admin</option>
                            <option value="Trainee">Trainee</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userId">User ID</label> <!-- USER ID -->
                        <input type="text" id="userId" readonly required />
                    </div>
                </div>
                <label for="userEmail">Email</label> <!-- EMAIL -->
                <input type="text"
                       id="userEmail"
                       placeholder="username@mbtraining.ph"
                       value="@mbtraining.ph"
                       required />


                <label for="tempPassword">Temporary Password</label> <!-- TEMP PASSWORD -->
                <input type="password"
                       id="tempPassword"
                       placeholder="Temporary password"
                       required />

                <div class="btn-row">
                    <button type="button" class="btn-box clear-btn" id="clearAllBtn">
                        <i class="material-icons">clear_all</i> Clear All
                    </button>
                    <button type="submit" class="btn-box add-btn">
                        <!-- BUTTON -->
                        <i class="material-icons">person_add</i> Add User
                    </button>
                </div>
            </form>
        </section>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("addUserForm");
            const userTypeSelect = document.getElementById("userType");
            const emailInput = document.getElementById("userEmail");
            const userIdInput = document.getElementById("userId");
            const clearBtn = document.getElementById("clearAllBtn");

            // --- Auto-generate User ID ---
            userTypeSelect.addEventListener("change", () => {
                const prefix =
                    userTypeSelect.value === "SME" ? "S" :
                        userTypeSelect.value === "Admin" ? "A" :
                            userTypeSelect.value === "Trainee" ? "T" :
                                "";
                const num = Math.floor(1000 + Math.random() * 9000);
                userIdInput.value = prefix + num;
            });

            // --- Force company email domain ---
            emailInput.addEventListener("input", () => {
                let val = emailInput.value.trim();
                if (!val.endsWith("@mbtraining.ph")) {
                    val = val.split("@")[0];
                    emailInput.value = val + "@mbtraining.ph";
                }
            });

            // --- Clear form ---
            clearBtn.addEventListener("click", (e) => {
                e.preventDefault();
                form.reset();
                emailInput.value = "@mbtraining.ph";
                userIdInput.value = "";
            });

            // --- Handle form submission ---
            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const fullName = document.getElementById("userName").value.trim();
                const userType = userTypeSelect.value;
                const email = emailInput.value.trim();
                const password = document.getElementById("tempPassword").value.trim();

                if (!fullName || !userType || !email || !password) {
                    alert("⚠️ Please fill in all required fields.");
                    return;
                }

                try {
                    const res = await fetch("http://localhost:3000/api/users/add", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ fullName, userType, email, password }),
                    });

                    const data = await res.json();

                    if (res.ok && data.success) {
                        alert(`✅ User added successfully!
                        Name: ${data.user.fullName}
                        Type: ${data.user.userType}
                        Email: ${data.user.email}`);

                        form.reset();
                        emailInput.value = "@mbtraining.ph";
                        userIdInput.value = "";
                    } else {
                        alert("❌ Failed to add user: " + (data.message || "Unknown error"));
                    }
                } catch (err) {
                    console.error("❌ Error adding user:", err);
                    alert("❌ Server error. Please try again later.");
                }
            });
        });
    </script>
</body>
</html>